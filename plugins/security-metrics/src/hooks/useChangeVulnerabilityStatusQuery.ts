import { useMutation, useQueryClient } from '@tanstack/react-query';
import { getAuthenticationTokens } from '../utils/authenticationUtils';
import { MetricTypes } from '../utils/MetricTypes';
import { useConfig } from './getConfig';
import { put } from '../api/client';

type ChangeStatusVariables = {
  componentName: string;
  vulnerabilityId: string;
  status: string;
  comment?: string;
  changedBy?: string;
};

const changeStatusQueryKeys = {
  changeStatus: (vulnerabilityId: string) => ['changeStatus', vulnerabilityId],
};

export const useChangeVulnerabilityStatusQuery = () => {
  const queryClient = useQueryClient();
  const { config, backstageAuthApi, microsoftAuthApi, endpointUrl } = useConfig(
    MetricTypes.changeStatusVulnerability,
  );

  return useMutation<any, unknown, ChangeStatusVariables>({
    mutationFn: async ({
      componentName,
      vulnerabilityId,
      status,
      comment,
      changedBy,
    }) => {
      const { entraIdToken, backstageToken } = await getAuthenticationTokens(
        config,
        backstageAuthApi,
        microsoftAuthApi,
      );
      return put<
        {
          componentName: string;
          vulnerabilityId: string;
          status: string;
          comment?: string;
          changedBy?: string;
          entraIdToken: string;
        },
        any
      >(endpointUrl, backstageToken, {
        componentName,
        vulnerabilityId,
        status,
        comment,
        changedBy,
        entraIdToken,
      });
    },
    onSuccess: (_data, variables) => {
      return queryClient.invalidateQueries({
        queryKey: changeStatusQueryKeys.changeStatus(variables.vulnerabilityId),
      });
    },
  });
};
