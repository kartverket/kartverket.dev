import { useState } from 'react';
import { usePaginationProps } from '../../hooks/usePagination';
import { Vulnerability } from '../../typesFrontend';
import { SortableHeader, sortableHeaders, sortVulnerabilities } from './utils';
import { VulnerabilityTableRow } from './VulnerabilityTableRow';
import TableContainer from '@mui/material/TableContainer';
import Paper from '@mui/material/Paper';
import Table from '@mui/material/Table';
import TableHead from '@mui/material/TableHead';
import TableRow from '@mui/material/TableRow';
import TableCell from '@mui/material/TableCell';
import TableSortLabel from '@mui/material/TableSortLabel';
import TableBody from '@mui/material/TableBody';
import TableFooter from '@mui/material/TableFooter';
import TablePagination from '@mui/material/TablePagination';
import Tooltip from '@mui/material/Tooltip';
import InfoIcon from '@mui/icons-material/Info';
import Box from '@mui/material/Box';
import { useSearchParams } from 'react-router-dom';
import { ContextDescriptions } from './ContextDescriptions';

type Props = {
  vulnerabilities: Vulnerability[];
  componentName: string;
  initialRowsPerPage: number;
};

export const VulnerabilityTable = ({
  vulnerabilities,
  componentName,
  initialRowsPerPage,
}: Props) => {
  const [sp] = useSearchParams();

  const initialSortType: SortableHeader =
    sp.get('sort') === 'discoveredAt' ? 'Dato' : 'Alvorlighetsgrad';

  const [sortType, setSortType] = useState<SortableHeader>(initialSortType);
  const [sortDir, setSortDir] = useState<'asc' | 'desc'>('desc');

  const paginationProps = usePaginationProps(
    vulnerabilities.length,
    0,
    initialRowsPerPage,
  );
  const { page, rowsPerPage } = paginationProps;

  return (
    <TableContainer component={Paper}>
      <Table size="small" sx={{ tableLayout: 'fixed', minWidth: 800 }}>
        <TableHead>
          <TableRow>
            <TableCell>Id</TableCell>
            <TableCell width="25%">Beskrivelse</TableCell>
            {sortableHeaders.map(header => (
              <TableCell key={header} sortDirection={sortDir}>
                <Box display="flex" alignItems="center">
                  <TableSortLabel
                    active={sortType === header}
                    direction={sortDir}
                    onClick={() => {
                      setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                      setSortType(header);
                    }}
                  >
                    {header}
                  </TableSortLabel>
                  {header === 'Dato' && (
                    <Tooltip title="Datoen da sikkerhetsmetrikker-APIet først oppdaget sårbarheten">
                      <InfoIcon fontSize="small" sx={{ ml: 0.5 }} />
                    </Tooltip>
                  )}
                </Box>
              </TableCell>
            ))}
            <TableCell>
              <Box display="flex" alignItems="center" gap={1}>
                Kontekst
                <Tooltip title={<ContextDescriptions />}>
                  <InfoIcon fontSize="small" />
                </Tooltip>
              </Box>
            </TableCell>

            <TableCell width="10%" />
          </TableRow>
        </TableHead>
        <TableBody>
          {vulnerabilities
            .sort((a, b) => sortVulnerabilities(a, b, sortType, sortDir))
            .slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage)
            .map(vulnerability => (
              <VulnerabilityTableRow
                key={vulnerability.vulnerabilityId}
                vulnerability={vulnerability}
                componentName={componentName}
              />
            ))}
        </TableBody>
        <TableFooter>
          <TableRow>
            <TablePagination colSpan={8} {...paginationProps} />
          </TableRow>
        </TableFooter>
      </Table>
    </TableContainer>
  );
};
