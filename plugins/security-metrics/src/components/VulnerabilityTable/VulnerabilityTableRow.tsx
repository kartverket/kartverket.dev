import { KeyboardArrowDown, KeyboardArrowUp } from '@mui/icons-material';
import Typography from '@mui/material/Typography';
import { styled } from '@mui/system';
import { formatDate } from 'date-fns';
import { useState } from 'react';
import { Status, Vulnerability } from '../../typesFrontend';
import { ScannerTag } from './ScannerTag';
import { SeverityTag } from './SeverityTag';
import TableCell from '@mui/material/TableCell';
import Stack from '@mui/material/Stack';
import IconButton from '@mui/material/IconButton';
import TableRow, { tableRowClasses } from '@mui/material/TableRow';
import { TableRowCollapse } from './TableRowCollapse';
import { StatusDialog } from './ChangeStatus/StatusDialog';
import { isRecent } from '../../utils/isRecent';
import { findBestId } from '../utils';
import CommentOutlinedIcon from '@mui/icons-material/CommentOutlined';
import CallMadeIcon from '@mui/icons-material/CallMade';
import Chip, { ChipProps } from '@mui/material/Chip';
import Tooltip from '@mui/material/Tooltip';
import Box from '@mui/material/Box';
import { VulnerabilityContext } from './VulnerabilityContext';

const StatusLabel: Record<Status, string> = {
  IKKE_STARTET: 'Ikke startet',
  PABEGYNT: 'Påbegynt',
  AKSEPTERT: 'Akseptert',
};

const statusColor: Record<Status, ChipProps['color']> = {
  IKKE_STARTET: 'default',
  PABEGYNT: 'primary',
  AKSEPTERT: 'success',
};

const StyledTableRow = styled(TableRow, {
  shouldForwardProp: prop => prop !== 'accepted',
})<{ accepted?: boolean }>(({ theme, accepted }) => ({
  [`&.${tableRowClasses.root}:nth-of-type(even)`]: {
    borderBottom: `1px solid ${theme.palette.divider}`,
  },
  [`&.${tableRowClasses.root}`]: {
    backgroundColor: theme.palette.background.paper,
  },
  ...(accepted && {
    opacity: 0.3,
  }),
}));

type Props = {
  vulnerability: Vulnerability;
  componentName: string;
};

export const VulnerabilityTableRow = ({
  vulnerability,
  componentName,
}: Props) => {
  const [open, setOpen] = useState(false);
  const [openStatusDialog, setOpenStatusDialog] = useState(false);

  const [status, setStatus] = useState<Status>(vulnerability.status);
  const [comment, setComment] = useState(vulnerability.comment || '');
  const [changedBy, setChangedBy] = useState(vulnerability.changedBy || '');

  const shownId = findBestId(vulnerability);

  const handleOpenStatusDialog = () => {
    setOpenStatusDialog(true);
  };

  const handleCloseStatusDialog = () => {
    setOpenStatusDialog(false);
  };

  return (
    <>
      <StyledTableRow accepted={status === 'AKSEPTERT'}>
        <TableCell>
          <Stack direction="row" alignItems="center" spacing={1}>
            <Typography component="span">{shownId}</Typography>

            {isRecent(vulnerability.dateFirstSeen, 7) && (
              <Typography
                variant="body2"
                component="span"
                sx={{
                  color: 'success.main',
                  fontWeight: 600,
                  wordBreak: 'keep-all',
                }}
              >
                Ny
              </Typography>
            )}
          </Stack>
        </TableCell>

        <TableCell>
          <Typography>{vulnerability.summary}</Typography>
        </TableCell>

        <TableCell>
          <Typography>
            {vulnerability.dateFirstSeen
              ? formatDate(vulnerability.dateFirstSeen, 'dd.MM.yyyy')
              : '–'}
          </Typography>
        </TableCell>

        <TableCell>
          <Stack gap={1}>
            {vulnerability.scanners.map(s => (
              <ScannerTag key={s} scanner={s} />
            ))}
          </Stack>
        </TableCell>

        <TableCell sx={{ verticalAlign: 'middle' }}>
          <SeverityTag severity={vulnerability.severity} />
        </TableCell>

        <TableCell sx={{ verticalAlign: 'middle' }}>
          <Box display="flex" alignItems="center" gap={1.5}>
            <Chip
              clickable
              onClick={handleOpenStatusDialog}
              label={StatusLabel[status]}
              color={statusColor[status]}
              size="small"
              deleteIcon={<CallMadeIcon fontSize="small" />}
              onDelete={handleOpenStatusDialog}
              sx={{ borderRadius: 1, m: 0 }}
            />

            {comment && (
              <Tooltip title={comment}>
                <CommentOutlinedIcon fontSize="small" color="action" />
              </Tooltip>
            )}
          </Box>

          <StatusDialog
            componentName={componentName}
            vulnerabilityId={vulnerability.vulnerabilityId}
            openStatusDialog={openStatusDialog}
            handleCloseStatusDialog={handleCloseStatusDialog}
            changedBy={changedBy}
            setChangedBy={setChangedBy}
            changedAt={vulnerability.changedAt}
            comment={comment}
            setComment={setComment}
            status={status}
            setStatus={setStatus}
          />
        </TableCell>

        <TableCell sx={{ verticalAlign: 'middle' }}>
          <VulnerabilityContext vulnerability={vulnerability} />
        </TableCell>

        <TableCell align="right" sx={{ px: 4 }}>
          <IconButton size="medium" onClick={() => setOpen(!open)}>
            {open ? <KeyboardArrowUp /> : <KeyboardArrowDown />}
          </IconButton>
        </TableCell>
      </StyledTableRow>

      <StyledTableRow>
        <TableCell sx={{ p: 0 }} colSpan={7}>
          <TableRowCollapse
            vulnerability={vulnerability}
            open={open}
            comment={comment}
            changedBy={changedBy}
            changedAt={vulnerability.changedAt}
            handleOpenStatusDialog={handleOpenStatusDialog}
          />
        </TableCell>
      </StyledTableRow>
    </>
  );
};
