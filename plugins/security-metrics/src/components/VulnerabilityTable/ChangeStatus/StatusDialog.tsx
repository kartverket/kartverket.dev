import { Stack } from '@mui/system';
import { ErrorBanner } from '../../ErrorBanner';
import Dialog from '@mui/material/Dialog';
import DialogTitle from '@mui/material/DialogTitle';
import DialogContent from '@mui/material/DialogContent';
import TextField from '@mui/material/TextField';
import DialogActions from '@mui/material/DialogActions';
import Button from '@mui/material/Button';
import { useChangeVulnerabilityStatusQuery } from '../../../hooks/useChangeVulnerabilityStatusQuery';
import Box from '@mui/material/Box';
import FormControl from '@mui/material/FormControl';
import RadioGroup from '@mui/material/RadioGroup';
import FormControlLabel from '@mui/material/FormControlLabel';
import Radio from '@mui/material/Radio';
import { Status } from '../../../typesFrontend';
import Tooltip from '@mui/material/Tooltip';
import InfoIcon from '@mui/icons-material/Info';
import { BASIC_COLORS } from '../../../colors';
import { useState } from 'react';
import { SpinnerButton } from './SpinnerButton';
import { OldLastEditedBy } from './OldLastEditedBy';
import { LastEditedBy } from './LastEditedBy';
import { featureFlagsApiRef, useApi } from '@backstage/core-plugin-api';

interface Props {
  componentName: string;
  vulnerabilityId: string;
  openStatusDialog: boolean;
  handleCloseStatusDialog: () => void;
  changedBy: string;
  setChangedBy: React.Dispatch<React.SetStateAction<string>>;
  changedAt: Date;
  comment: string;
  setComment: React.Dispatch<React.SetStateAction<string>>;
}

export const StatusDialog = ({
  componentName,
  vulnerabilityId,
  openStatusDialog,
  handleCloseStatusDialog,
  changedBy,
  setChangedBy,
  changedAt,
  comment,
  setComment,
  status,
  setStatus,
}: Props & { status: Status; setStatus: (s: Status) => void }) => {
  const featureFlagsApi = useApi(featureFlagsApiRef);
  const isEntraIDForStatusEnabled =
    featureFlagsApi.isActive('entraid-for-status');

  const statusMutation = useChangeVulnerabilityStatusQuery();

  const [draftStatus, setDraftStatus] = useState<Status>(status);
  const [draftComment, setDraftComment] = useState(comment || '');
  const [draftChangedBy, setDraftChangedBy] = useState(changedBy ?? '');

  const wasChangedBefore = Boolean(changedAt);
  const hasChanges =
    draftStatus !== status ||
    draftComment.trim() !== comment.trim() ||
    draftChangedBy.trim() !== changedBy.trim();

  const isAccepted = draftStatus === 'AKSEPTERT';
  const acceptanceValid =
    !isAccepted ||
    (draftComment.trim().length > 0 &&
      (isEntraIDForStatusEnabled || draftChangedBy.trim().length > 0));

  const canSave =
    (!wasChangedBefore || hasChanges) &&
    acceptanceValid &&
    !statusMutation.isPending;

  const resetDraft = () => {
    setDraftStatus(status);
    setDraftComment(comment);
    setDraftChangedBy(changedBy);
  };

  const handleSave = () => {
    if (!canSave) return;

    statusMutation.mutate(
      {
        componentName,
        vulnerabilityId,
        status: draftStatus,
        comment: draftComment,
        ...(isEntraIDForStatusEnabled ? {} : { changedBy: draftChangedBy }),
      },
      {
        onSuccess: () => {
          setStatus(draftStatus);
          setComment(draftComment);
          setChangedBy?.(draftChangedBy);
          handleCloseStatusDialog();
        },
      },
    );
  };

  const handleCancel = () => {
    handleCloseStatusDialog();
  };

  return (
    <Dialog
      open={openStatusDialog}
      onClose={handleCancel}
      TransitionProps={{ onEnter: resetDraft }}
    >
      <DialogTitle>Status for sårbarhet {vulnerabilityId}</DialogTitle>

      <DialogContent sx={{ overflowY: 'visible' }}>
        <Stack spacing={2}>
          <section>
            <FormControl error={false}>
              <RadioGroup
                value={draftStatus}
                onChange={e => {
                  setDraftStatus(e.target.value as Status);
                }}
              >
                <Box display="flex" flexDirection="row">
                  <FormControlLabel
                    value="IKKE_STARTET"
                    control={<Radio />}
                    label="Ikke startet"
                  />
                  <FormControlLabel
                    value="PABEGYNT"
                    control={<Radio />}
                    label="Påbegynt"
                  />
                  <FormControlLabel
                    value="AKSEPTERT"
                    control={<Radio />}
                    label={
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <span>Akseptert</span>
                        <Tooltip title="Hva det betyr å akseptere en sårbarhet kan teamet selv definere. Det kan bety at sårbarheten er kjent og reell, men at man aksepterer risikoen og beslutter å ikke fikse den.">
                          <InfoIcon
                            sx={{
                              fontSize: 16,
                              color: BASIC_COLORS.LIGHT_GREY,
                            }}
                          />
                        </Tooltip>
                      </Box>
                    }
                  />
                </Box>
              </RadioGroup>
            </FormControl>
          </section>

          <section>
            <TextField
              label="Kommentar"
              multiline
              minRows={3}
              value={draftComment}
              onChange={e => {
                setDraftComment(e.target.value);
              }}
              fullWidth
              required={isAccepted}
            />
          </section>

          {!isEntraIDForStatusEnabled ? (
            <OldLastEditedBy
              draftChangedBy={draftChangedBy}
              setDraftChangedBy={setDraftChangedBy}
              hasChanges={hasChanges}
              changedAt={changedAt}
            />
          ) : (
            !hasChanges && (
              <LastEditedBy changedBy={changedBy} changedAt={changedAt} />
            )
          )}

          {statusMutation.isError && (
            <ErrorBanner errorMessage="Kunne ikke endre status på sårbarhet. Gjerne gi tilbakemelding i #sikkerhetsmetrikker-tilbakemelding under Support dersom problemet vedvarer." />
          )}
        </Stack>
      </DialogContent>

      <DialogActions>
        <Box
          display="flex"
          pb={2}
          pr={2}
          gap={1}
          flexDirection="column"
          alignItems="flex-end"
        >
          <Box sx={{ display: 'flex', gap: 1 }}>
            <Button onClick={handleCancel}>Avbryt</Button>
            <SpinnerButton
              loading={statusMutation.isPending}
              disabled={!canSave}
              onClick={handleSave}
            >
              Lagre
            </SpinnerButton>
          </Box>
        </Box>
      </DialogActions>
    </Dialog>
  );
};
