import { Stack } from '@mui/system';
import { ErrorBanner } from '../../ErrorBanner';
import Dialog from '@mui/material/Dialog';
import DialogTitle from '@mui/material/DialogTitle';
import DialogContent from '@mui/material/DialogContent';
import TextField from '@mui/material/TextField';
import DialogActions from '@mui/material/DialogActions';
import Button from '@mui/material/Button';
import { useChangeVulnerabilityStatusQuery } from '../../../hooks/useChangeVulnerabilityStatusQuery';
import { SpinnerButton } from './SpinnerButton';
import Box from '@mui/material/Box';
import FormControl from '@mui/material/FormControl';
import FormLabel from '@mui/material/FormLabel';
import RadioGroup from '@mui/material/RadioGroup';
import FormControlLabel from '@mui/material/FormControlLabel';
import Radio from '@mui/material/Radio';
import { Status } from '../../../typesFrontend';
import Tooltip from '@mui/material/Tooltip';
import InfoIcon from '@mui/icons-material/Info';
import { BASIC_COLORS } from '../../../colors';

interface Props {
  componentName: string;
  vulnerabilityId: string;
  openAcceptDialog: boolean;
  handleCloseAcceptDialog: () => void;
  changedBy: string;
  changedAt: Date;
  comment: string;
  setChangedBy: React.Dispatch<React.SetStateAction<string>>;
  setComment: React.Dispatch<React.SetStateAction<string>>;
}

import { useEffect, useState } from 'react';
import { formatDate } from 'date-fns';

export const AcceptDialog = ({
  componentName,
  vulnerabilityId,
  openAcceptDialog,
  handleCloseAcceptDialog,
  changedBy,
  changedAt,
  comment,
  setChangedBy,
  setComment,
  status,
  setStatus,
}: Props & { status: Status; setStatus: (s: Status) => void }) => {
  const acceptMutation = useChangeVulnerabilityStatusQuery();

  const [draftStatus, setDraftStatus] = useState<Status>(status);
  const [draftComment, setDraftComment] = useState(comment);
  const [draftChangedBy, setDraftChangedBy] = useState(changedBy);

  useEffect(() => {
    if (!openAcceptDialog) return;
    setDraftStatus(status);
    setDraftComment(comment);
    setDraftChangedBy(changedBy);
  }, [openAcceptDialog, status, comment, changedBy]);

  const isAccepted = draftStatus === 'AKSEPTERT';
  const canSave =
    !isAccepted ||
    (draftComment.trim().length > 0 && draftChangedBy.trim().length > 0);

  const handleSave = () => {
    if (!canSave) return;

    acceptMutation.mutate(
      {
        componentName,
        vulnerabilityId,
        status: draftStatus,
        comment: draftComment,
        changedBy: draftChangedBy,
      },
      {
        onSuccess: () => {
          setStatus(draftStatus);
          setComment(draftComment);
          setChangedBy(draftChangedBy);
          handleCloseAcceptDialog();
        },
      },
    );
  };

  const handleCancel = () => {
    handleCloseAcceptDialog();
  };

  return (
    <Dialog open={openAcceptDialog} onClose={handleCancel}>
      <DialogTitle>Status for sårbarhet {vulnerabilityId}</DialogTitle>

      <DialogContent sx={{ overflowY: 'visible' }}>
        <Stack spacing={2}>
          <section>
            <FormControl error={false}>
              <FormLabel>Status</FormLabel>
              <RadioGroup
                value={draftStatus}
                onChange={e => setDraftStatus(e.target.value as Status)}
              >
                <Box display="flex" flexDirection="row">
                  <FormControlLabel
                    value="IKKE_STARTET"
                    control={<Radio />}
                    label="Ikke startet"
                  />
                  <FormControlLabel
                    value="PABEGYNT"
                    control={<Radio />}
                    label="Påbegynt"
                  />
                  <FormControlLabel
                    value="AKSEPTERT"
                    control={<Radio />}
                    label={
                      <Box display="flex" alignItems="center" gap={0.5}>
                        <span>Akseptert</span>
                        <Tooltip title="Hva det betyr å akseptere en sårbarhet kan teamet selv definere. Det kan bety at sårbarheten er kjent og reell, men at man aksepterer risikoen og beslutter å ikke fikse den.">
                          <InfoIcon
                            sx={{
                              fontSize: 16,
                              color: BASIC_COLORS.LIGHT_GREY,
                            }}
                          />
                        </Tooltip>
                      </Box>
                    }
                  />
                </Box>
              </RadioGroup>
            </FormControl>
          </section>

          <section>
            <TextField
              label={isAccepted ? 'Kommentar' : 'Kommentar (valgfritt)'}
              multiline
              minRows={3}
              value={draftComment}
              onChange={e => setDraftComment(e.target.value)}
              fullWidth
              required={isAccepted}
            />
          </section>

          <section>
            <TextField
              label={isAccepted ? 'Endret av' : 'Endret av (valgfritt)'}
              value={draftChangedBy}
              onChange={e => setDraftChangedBy(e.target.value)}
              fullWidth
              required={isAccepted}
            />
          </section>

          {changedAt && (
            <section>
              Sist endret: {formatDate(changedAt, 'dd.MM.yyyy')}
            </section>
          )}

          {acceptMutation.isError && (
            <ErrorBanner errorMessage="Kunne ikke endre status på sårbarhet. Gjerne gi tilbakemelding i #sikkerhetsmetrikker-tilbakemelding under Support dersom problemet vedvarer." />
          )}
        </Stack>
      </DialogContent>

      <DialogActions>
        <Box sx={{ pb: 2, pr: 2, display: 'flex', gap: 1 }}>
          <Button onClick={handleCancel}>Avbryt</Button>
          <SpinnerButton
            loading={acceptMutation.isPending}
            disabled={!canSave}
            onClick={handleSave}
          >
            Lagre
          </SpinnerButton>
        </Box>
      </DialogActions>
    </Dialog>
  );
};
