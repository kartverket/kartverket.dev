import { RepositorySummary, Repository } from '../../typesFrontend';
import { CardTitle } from '../CardTitle';
import {
  aggregateSeverityCounts,
  getTotalVulnerabilityCount,
} from '../../mapping/getSeverityCounts';
import {
  Cell,
  Label,
  Legend,
  Pie,
  PieChart,
  ResponsiveContainer,
} from 'recharts';
import {
  getSeverityColor,
  getStandardSeverityFormat,
  SEVERITY_ORDER,
  severityLegendSorter,
} from '../utils';
import ThumbUpIcon from '@mui/icons-material/ThumbUp';
import Box from '@mui/material/Box';
import { useTheme } from '@mui/material/styles';
import Typography from '@mui/material/Typography';
import Stack from '@mui/material/Stack';
import Tooltip from '@mui/material/Tooltip';
import InfoIcon from '@mui/icons-material/Info';

type Props = {
  data: RepositorySummary[] | Repository;
  averageDays?: number | null;
};

export const VulnerabilityCountsOverview = ({ data, averageDays }: Props) => {
  const theme = useTheme();
  const items: (RepositorySummary | Repository)[] = Array.isArray(data)
    ? data
    : [data];

  const countEnabledScanners = (config: {
    dependabot: boolean;
    codeQL: boolean;
    pharos: boolean;
    sysdig: boolean;
  }) => Object.values(config).filter(Boolean).length;

  const ALL_SCANNERS_COUNT = 4;

  const counts = aggregateSeverityCounts(items, r => r.severityCount);
  const total = getTotalVulnerabilityCount(counts);

  const chartData = SEVERITY_ORDER.map(sev => ({
    key: sev,
    name: getStandardSeverityFormat(sev),
    value: counts[sev] ?? 0,
  })).filter(d => d.value > 0);

  const hasMttr = typeof averageDays === 'number';

  const hasScannerConfig = items.every(item => !!item.scannerConfig);

  const allScannersOnForAllItems =
    hasScannerConfig &&
    items.every(item => {
      const cfg = item.scannerConfig;
      const enabled = countEnabledScanners(cfg);
      return enabled === ALL_SCANNERS_COUNT;
    });

  const shouldShowScannerHint = total === 0 && !allScannersOnForAllItems;

  return (
    <CardTitle
      title={
        <Stack>
          <Typography variant="h6" sx={{ fontWeight: 600 }}>
            Sårbarheter
          </Typography>
          {hasMttr && (
            <Stack direction="row" alignItems="center" spacing={0.5}>
              <Typography variant="body2" sx={{ color: 'text.secondary' }}>
                MTTH: {Math.round(averageDays)} dager
              </Typography>
              <Tooltip title="Mean time to handle: gjennomsnittlig antall dager siden en sårbarhet ble oppdaget, fram til den blir løst eller akseptert – eller til dagens dato hvis den fortsatt er åpen">
                <InfoIcon fontSize="small" sx={{ color: 'text.secondary' }} />
              </Tooltip>
            </Stack>
          )}
        </Stack>
      }
    >
      {total === 0 ? (
        <Box
          display="flex"
          flexDirection="column"
          alignItems="center"
          justifyContent="center"
          height="100%"
          mb={5}
          aria-label="Ingen sårbarheter funnet"
        >
          <ThumbUpIcon color="success" fontSize="large" sx={{ mb: 1 }} />
          <Stack spacing={0.5} alignItems="center">
            <Typography fontWeight={500}>Ingen sårbarheter funnet</Typography>
            {shouldShowScannerHint && (
              <Typography
                variant="body2"
                sx={{ color: 'text.secondary', textAlign: 'center' }}
              >
                Er alle relevante scannere skrudd på?
              </Typography>
            )}
          </Stack>
        </Box>
      ) : (
        <Stack alignItems="center" justifyContent="center" height="100%">
          <Box width="100%" flex={1}>
            <ResponsiveContainer width="95%" height="100%">
              <PieChart>
                <Pie
                  data={chartData}
                  dataKey="value"
                  nameKey="name"
                  innerRadius={70}
                  outerRadius={90}
                  stroke="transparent"
                >
                  {chartData.map(d => (
                    <Cell key={d.key} fill={getSeverityColor(d.key)} />
                  ))}
                  <Label
                    position="center"
                    value={total}
                    style={{
                      fontSize: '28px',
                      fill: theme.palette.text.primary,
                    }}
                  />
                </Pie>
                <Legend
                  layout="vertical"
                  align="right"
                  verticalAlign="middle"
                  iconType="circle"
                  iconSize={15}
                  itemSorter={severityLegendSorter}
                  formatter={(value: string, entry: any) => (
                    <Box
                      component="span"
                      sx={{
                        display: 'inline-flex',
                        justifyContent: 'space-between',
                        minWidth: '125px',
                        mt: '5px',
                        color: 'text.primary',
                      }}
                    >
                      <Typography component="span">{value}</Typography>
                      <Typography component="span" sx={{ fontWeight: 500 }}>
                        {entry?.payload?.value}
                      </Typography>
                    </Box>
                  )}
                />
              </PieChart>
            </ResponsiveContainer>
          </Box>
        </Stack>
      )}
    </CardTitle>
  );
};
